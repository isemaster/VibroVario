### 1. Краткое описание прибора

Прибор — это компактный барометрический вариометр с e‑ink‑дисплеем и виброиндикацией, рассчитанный на параплан/дельтаплан/планер и т.п.

Он выполняет следующие функции:

- измеряет **барометрическую высоту** и **вертикальную скорость (варио)**;
- показывает:
  - время полёта (секундомер),
  - текущую и относительную высоту (относительно точки старта),
  - максимальный набор и максимальное снижение за полёт,
  - температуру,
  - напряжение и процент заряда батареи,
  - текущее время и дату (из RTC);
- информирует о подъёмах/снижениях с помощью **вибромотора** (можно лететь, не глядя на экран);
- экономично расходует энергию: использует e‑ink‑дисплей, аппаратный глубокий сон ESP32, отключает датчики и Wi‑Fi.

---

### 2. Как прибор работает (по программе)

#### 2.1. Аппаратная часть (по коду)

- **Контроллер:** ESP32.
- **Барометрический датчик:** BMP3XX (I²C 0x76/0x77).
- **Акселерометр:** BMA423 (I²C 0x18).
- **Часы реального времени (RTC):** на адресе 0x51 (тип вроде PCF8563 или аналогичный).
- **Дисплей:** e‑paper 1.54" GDEH0154D67 (200×200, библиотека GxEPD2).
- **Вибромотор:** на пине `PIN_VIBRO = 13`.
- **Кнопки:**  
  - BTN_SELECT = 35 — старт/калибровка варио,  
  - BTN_RIGHT = 4 — стоп полёта / спец. функция в режиме часов,  
  - BTN_BACK = 25 — включение/выключение (просыпание и переход в сон).
- **Измерение батареи:** вход `PIN_BATT = 34` (аналоговый АЦП; используется делитель ×2).

---

#### 2.2. Режимы работы (состояния)

В коде определено несколько состояний:

- `SLEEP` — глубокий сон:
  - питание варио‑части и вибро отключено,
  - дисплей переведён в hibernate,
  - I²C и Wi‑Fi выключены,
  - ESP32 спит в deep sleep и просыпается только от кнопки BTN_BACK (по фронту).

- `IDLE` — режим часов/ожидания:
  - на экране показываются напряжение батареи, время и дата,
  - через 60 секунд без нажатий прибор сам уходит в глубокий сон,
  - отсюда можно запустить полёт (кнопка SELECT) или обнулить время RTC (кнопка RIGHT — служебная функция).

- `RUNNING` — основной режим полёта:
  - работают датчики,
  - крутится фоновая задача с частотой ~50 Гц,
  - обновляются высота, варьё, виброиндикация, таймер полёта, max/min варьё.

- `STOPPED` — полёт завершён:
  - датчики остаются инициализированы, но секундомер остановлен,
  - вибро выключено,
  - на экране «заморожены» результаты полёта,
  - из этого состояния можно:
    - начать новый полёт (SELECT),
    - уйти в сон (BACK).

---

#### 2.3. Измерения и алгоритмы

##### 2.3.1. Барометрическая высота

- Датчик BMP3XX инициализируется с:
  - температурным oversampling ×4,
  - давлением ×8,
  - IIR‑фильтр коэффициент 3,
  - частота выдачи данных 50 Гц.
- Каждый цикл вызывается `bmp.performReading()` и считывается **высота** функцией:
  ```cpp
  bmp.readAltitude(SEALEVELPRESSURE_HPA)
  ```
  где `SEALEVELPRESSURE_HPA = 1012.5` — фиксированное давление на уровне моря.

То есть прибор даёт **барометрическую высоту относительно условного уровня моря**, заданного этим постоянным QNH.  
Абсолютное значение «Sea, m» будет слегка отличаться от реальных карт/аэродромного QNH, но для **относительной высоты и варьё** это не критично.

---

##### 2.3.2. Акселерометр и компенсация наклона

С акселерометра считываются сырые данные по осям X/Y/Z, затем переводятся в единицы g:

```cpp
ax = rx / 8192.0f;  // диапазон ±4g
...
```

Далее делается важный шаг — **устранение зависимости от наклона прибора**:

1. Рассчитывается **модуль вектора ускорения**:
   ```cpp
   acc_mag = sqrt(ax*ax + ay*ay + az*az);
   ```
   Это значение не зависит от ориентации: как бы прибор ни был повернут, модуль при покое ≈ 1 g.

2. При калибровке (см. ниже) вычисляется и запоминается `gMagRef` — «эталонная» величина ускорения в покое (для конкретного датчика).

3. В полёте вычисляется:
   ```cpp
   acc_linear_g = acc_mag - data.gMagRef;
   ```
   - если перегрузка > 1g (активный подъем) → положительное значение,
   - если перегрузка < 1g (провал/снижение) → отрицательное.

4. Это значение переводится в м/с²:
   ```cpp
   acc_vert_input = acc_linear_g * 9.80665;
   ```
   В итоге получается **оценка вертикального линейного ускорения**, **независимая от наклона** прибора.

> Важно: пока работает вибромотор, акселерометр *временно игнорируется*, чтобы вибрация не искажала измерения. После выключения вибро выдерживается пауза 250 мс, прежде чем снова доверять данным акселерометра.

---

##### 2.3.3. Фильтр Кальмана: объединение барометра и ускорения

В коде реализован трёхмерный фильтр Кальмана `VarioKalman` с состоянием:

- z — высота (м),
- vz — вертикальная скорость (м/с),
- bias_z — смещение акселерометра.

На вход фильтра в каждый цикл подаётся:

- `acc_vert_input` — вертикальное ускорение (из акселерометра, как описано выше),
- `baro_alt` — высота с барометра,
- `dt` — шаг по времени между обновлениями (из `micros()`).

Фильтр:

- **прогнозирует** высоту и скорость по уравнениям движения с использованием измеренного ускорения;
- **корректирует** прогноз по барометрической высоте, устраняя дрейф и определяя верный знак скорости;
- отдельно моделирует медленное изменение `bias_z` — смещения в ускорении.

Чувствительность настроена двумя параметрами (в начале файла):

- `SENS_BARO_NOISE` — доверие к барометру (меньше значение → барометр считается «чище», варио получается чувствительнее, но шумнее);
- `SENS_ACCEL_TRUST` — доверие к акселерометру (больше значение → прибор агрессивнее реагирует на быстрые рывки, меньше сглаживание).

Выходы фильтра:

- `kalman.getAltitude()` → `data.alt` — сглаженная высота;
- `kalman.getVario()` → `data.vel` — вертикальная скорость (варио).

Скорость ограничивается по модулю ±25 м/с (защита от выбросов).

---

##### 2.3.4. Калибровка перед полётом

При нажатии SELECT в режиме IDLE/STOPPED запускается калибровка:

1. Включается питание датчиков (`PIN_VARIO_EN = 1`), инициализируется барометр и акселерометр.
2. На экране показывается надпись **«Calibrating…»**.
3. В течение ~1 секунды:
   - считывается акселерометр 100 раз,
   - для каждого измерения считается модуль вектора ускорения,
   - все значения усредняются → так находится `data.gMagRef` (реальное значение «1 g» для данного экземпляра датчика),
   - параллельно несколько раз обновляется фильтр Кальмана с нулевым ускорением, чтобы высота «успокоилась».
4. Проверка `gMagRef` — если получилась слишком странная величина (меньше 0.5 g или больше 1.5 g), берётся запасное значение 1.0.

Далее:

- начальная высота `startAlt` принимается равной текущей оценке высоты;
- maxV и minV сбрасываются в 0;
- «секундомер» сбрасывается и стартует;
- запускается фоновая задача `varioTask` (если ещё не была запущена);
- состояние переводится в `RUNNING`.

**Вывод:** калибровку нужно делать на *неподвижном* приборе.

---

##### 2.3.5. Отображение на экране в полёте

Функция `drawMain()` (обновление 1 раз в секунду) выводит:

Верхняя строка:

- слева — **время полёта** (часы:минуты:секунды) с момента старта (select), с учётом остановок (суммируется в `stopwatchElapsed`);
- по центру — **температура** (С, с одной цифрой после запятой);
- справа — **заряд батареи**:
  - измеряется напряжение батареи (ADC → мВ → В с учётом делителя ×2),
  - шкала 3.3 В = 0 %, 4.2 В ≈ 100 %.

Средняя часть (в RUNNING и STOPPED):

- заголовок: «Start, m   Sea, m»;
- под ним:
  - слева — **относительная высота** относительно точки старта:
    - `Start, m` = (текущая высота − высота старта), со знаком ±;
  - справа — **барометрическая высота над уровнем моря** (`Sea, m`) — целое число.

Нижняя часть:

- строка «Vario»;
- если `data.track == true` (спустя 5 секунд после старта полёта) — справа показываются:
  - `max+X.X min−Y.Y` — максимальный набор и максимальное снижение за полёт;
- крупными цифрами внизу — **текущая вертикальная скорость** (варио, м/с) с одним знаком после запятой, со знаком ±.

---

#### 2.4. Виброиндикация

Виброформирование идёт в отдельной задаче `varioTask` с частотой примерно 50 Гц.

Из скорости набора/снижения `data.vel` вычисляется требуемый режим:

- **Сильное снижение**:
  - если `v <= SINK_TRH` (SINK_TRH = −5.0 м/с),
  - вибромотор включается **непрерывно** — предупреждение об активном сливе высоты.

- **Подъём**:
  используются пороги:
  ```cpp
  LIFT_TH      = {0.2, 0.4, 0.8, 1.4, 2.0} м/с
  LIFT_PULSES  = {1,   2,   3,   4,   0}   импульсов
  ```
  По актуальному коду:
  - 0.2–0.4 м/с → 1 импульс,
  - 0.4–0.8 м/с → 2 импульса,
  - 0.8–1.4 м/с → 3 импульса,
  - 1.4–2.0 м/с → 4 импульса,
  - выше 2.0 м/с в текущем варианте массива получается 0 импульсов (вибро нет).

- **Слабые движения**:
  - |v| < 0.2 м/с → вибро не включается.

Параметры импульсов:

- длительность одного импульса `V_PULSE = 50` мс,
- пауза между импульсами в серии `V_GAP = 125` мс,
- пауза между сериями `V_PAUSE = 1000` мс,
- после выключения вибро — `VIBRO_COOLDOWN_MS = 250` мс до того, как снова позволить акселерометру участвовать в вычислениях.

---

#### 2.5. Питание и энергосбережение

- В глубокий сон (`goDeepSleep()`):
  - задача варио удаляется,
  - питание датчиков (`PIN_VARIO_EN`) и вибро выключено,
  - дисплей уходит в `hibernate`,
  - шина I²C закрыта,
  - Wi‑Fi полностью отключается,
  - настраивается пробуждение по BTN_BACK,
  - ESP32 уходит в `esp_deep_sleep_start()`.

- В режиме IDLE (часы):
  - датчики варио *ещё не включены*,
  - e‑ink обновляется, только когда нужно (при входе в режим и при отдельных действиях),
  - если за 60 секунд пользователь ничего не нажал → уход в deep sleep.

---

### 3. Инструкция для пилота

#### 3.1. Кнопки и индикация (общее)

Кнопки:

- **BACK** — включение/выключение:
  - из сна пробуждает прибор и выводит на экран часы,
  - из любого состояния при коротком нажатии переводит в режим часов, откуда прибор при следующем цикле уйдёт в сон.

- **SELECT**:
  - в режиме часов (IDLE) и после полёта (STOPPED):
    - запускает калибровку и старт нового полётного режима (RUNNING).
    
- **RIGHT**:
  - в режиме RUNNING:
    - останавливает полёт (секундомер замирает, вибро выключается, состояние → STOPPED);
  - в режиме IDLE:
    - служебная функция — сбрасывает время RTC в 00:00 (используется для тестов/настройки, в обычном полёте практически не нужна).

Основной полётный экран:

- Верхняя строка:
  - **часы:минуты:секунды полёта**,
  - **температура**,
  - **заряд батареи** в процентах.
- Средняя часть:
  - **Start, m** — относительная высота относительно точки старта (калибровки),
  - **Sea, m** — барометрическая высота над уровнем моря.
- Нижняя часть:
  - «Vario», затем **max/min вертикальной скорости**,
  - крупное число — **текущее варио** (м/с, + подъём, − снижение).

---

#### 3.2. Подготовка к полёту

1. Убедитесь, что батарея заряжена:
   - в режиме часов напряжение показывается в вольтах и процентах;
   - 4.2 В ≈ 100 %, 3.3 В ≈ почти разряжено.

2. Включите прибор:
   - нажмите кнопку **BACK**;
   - прибор проснётся и покажет **экран часов** (напряжение батареи, время, дату).

3. Закрепите прибор так, чтобы:
   - он был относительно стабилен (минимум тряски),
   - вы хорошо ощущали вибро (например, в кармане подвески или на запястье/руке — зависит от конструкции).

---

#### 3.3. Старт и калибровка

1. На экране часов нажмите кнопку **SELECT**.
2. Появится надпись **«Calibrating…»**:
   - **не двигайте прибор** во время калибровки (примерно 1–2 секунды),
   - в это время прибор:
     - измеряет барометрическую высоту,
     - калибрует акселерометр на 1 g.

3. После калибровки автоматически появится **основной полётный экран**, и прибор перейдёт в режим **RUNNING**:
   - секундомер времени полёта пойдёт от 00:00:00,
   - высота старта (текущая) запомнится как 0 по шкале «Start, m».

---

#### 3.4. Работа в полёте

На что смотреть:

- **Время полёта** — верхняя строка слева.
- **Температура** и **заряд батареи** — верхняя строка.
- **Относительная высота «Start, m»**:
  - положительное значение → вы выше точки старта,
  - отрицательное → ниже.
- **«Sea, m»** — высота относительно условного уровня моря (зависит от настроенного давления 1012.5 гПа, может отличаться от реального QNH).
- **Варио**:
  - крупное число внизу:
    - `+` — подъём (м/с),
    - `−` — снижение (м/с),
  - max/min — ваш максимальный набор и максимальное снижение с начала полёта.

Виброиндикация:

- **Непрерывная вибрация**:
  - означает **сильное снижение** (примерно быстрее −5 м/с),
  - это сигнал покинуть зону сильного слива.

- **Краткие пакеты вибраций** (подъём):
  - при слабом наборе 0.2–0.4 м/с — **1 короткий импульс** в серии;
  - 0.4–0.8 м/с — **2 импульса**;
  - 0.8–1.4 м/с — **3 импульса**;
  - 1.4–2.0 м/с — **4 импульса**;
  - между отдельными импульсами — пауза ~0.125 с, между сериями — ~1 с;
  - в текущей прошивке при наборе более ≈2 м/с вибрация **прекращается** (значение видно на экране, но вибро не даёт сигналов).

- **Отсутствие вибрации** означает:
  - либо вертикальная скорость в зоне «штиль» / очень слабые движения (< примерно 0.2 м/с),
  - либо, наоборот, уже очень сильный подъём (> 2 м/с, по текущей логике),
  - либо прибор не в режиме RUNNING (после остановки полёта или до запуска).

Таким образом, в полёте вы можете ориентироваться по вибро и почти не смотреть на экран:
- один-два лёгких «тычка» — слабый поток,
- три-четыре — более уверенный,
- непрерывный гул — активное снижение.

---

#### 3.5. Завершение полёта и выключение

После посадки:

1. Нажмите кнопку **RIGHT**, находясь в режиме RUNNING:
   - секундомер остановится,
   - состояние сменится на **STOPPED**,
   - вибро выключится,
   - на экране останутся итоговые значения полёта (высоты, max/min варио и т.д.).

2. Для выключения прибора:
   - нажмите **BACK**:
     - прибор покажет экран часов и тут же перейдёт в состояние SLEEP (глубокий сон).
   - либо, если вы в режиме часов (IDLE) и ничего не нажимаете ~60 секунд — прибор сам уйдёт в сон.

При следующем включении (BACK) вы снова увидите часы и сможете начать новый полёт через SELECT.

---

#### 3.6. Важные замечания

- **Калибровка только на неподвижном приборе.**  
  Во время появления надписи «Calibrating…» не трясите и не вращайте прибор. Иначе значение 1 g может получиться неточным, и варио будет немного смещено.

- **Барометрическая высота зависит от установленного в прошивке давления.**  
  Абсолютная «Sea, m» может не совпадать с реальным уровнем моря по метеоусловиям, но:
  - относительная высота «Start, m» корректна,
  - показания варио (м/с) остаются адекватными.

- **Вибро влияет на акселерометр.**  
  Поэтому во время работы вибромотора акселерометр временно не учитывается, чтобы не портить расчёт скорости — это сделано в прошивке автоматически.

- **Точные настройки чувствительности (SENS_BARO_NOISE, SENS_ACCEL_TRUST)** меняются только изменением прошивки. Если нужно «более резкое» или «более плавное» варио, это настраивается в коде.
